openapi: 3.0.3
info:
  title: CMS API
  description: Content Management System with RBAC and approval workflows
  version: 0.1.0
  contact:
    name: API Support

servers:
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: User authentication and session management
  - name: Roles
    description: Role management (CRUD operations)
  - name: Permissions
    description: Permission management
  - name: User Roles
    description: User-role assignments and effective permissions
  - name: Workflows
    description: Approval workflow management (currently for content; RBAC workflows planned for future)
  - name: Workflow Config
    description: Workflow configuration per entity type

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  info:
                    type: object
                    properties:
                      database:
                        type: object
                        properties:
                          status:
                            type: string
                            example: up

  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Create a new user account with email and password
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          headers:
            Set-Cookie:
              description: Refresh token in HTTP-only cookie
              schema:
                type: string
                example: refresh_token=abc123; HttpOnly; Secure; SameSite=Strict; Path=/auth; Max-Age=604800
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login with email and password
      description: Authenticate user and return JWT access and refresh tokens
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Refresh token in HTTP-only cookie
              schema:
                type: string
                example: refresh_token=abc123; HttpOnly; Secure; SameSite=Strict; Path=/auth; Max-Age=604800
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid credentials or user inactive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Exchange a valid refresh token for new access token.
        The refresh token is read from HTTP-only cookie (not request body).
        A new refresh token cookie is set on success (token rotation).
      operationId: refreshTokens
      parameters:
        - name: refresh_token
          in: cookie
          required: true
          description: HTTP-only cookie containing refresh token
          schema:
            type: string
      responses:
        '200':
          description: Tokens refreshed successfully
          headers:
            Set-Cookie:
              description: New refresh token in HTTP-only cookie
              schema:
                type: string
                example: refresh_token=abc123; HttpOnly; Secure; SameSite=Strict; Path=/auth; Max-Age=604800
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout current session
      description: |
        Invalidate the current session by reading refresh token from HTTP-only cookie.
        Clears the refresh token cookie on success.
      operationId: logout
      security:
        - bearerAuth: []
      parameters:
        - name: refresh_token
          in: cookie
          required: false
          description: HTTP-only cookie containing refresh token
          schema:
            type: string
      responses:
        '200':
          description: Logged out successfully
          headers:
            Set-Cookie:
              description: Clear refresh token cookie
              schema:
                type: string
                example: refresh_token=; HttpOnly; Secure; SameSite=Strict; Path=/auth; Max-Age=0
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user profile
      description: Return the authenticated user's profile information
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token (15 min expiry)

  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: SecurePass123!
        firstName:
          type: string
          maxLength: 100
          example: John
        lastName:
          type: string
          maxLength: 100
          example: Doe

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          example: SecurePass123!

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        email:
          type: string
          format: email
          example: user@example.com
        firstName:
          type: string
          nullable: true
          example: John
        lastName:
          type: string
          nullable: true
          example: Doe
        avatarUrl:
          type: string
          format: uri
          nullable: true
        isActive:
          type: boolean
          example: true
        emailVerifiedAt:
          type: string
          format: date-time
          nullable: true
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    TokenResponse:
      type: object
      description: Access token response. Refresh token is set via HTTP-only cookie.
      properties:
        accessToken:
          type: string
          description: JWT access token (15 min expiry)
        expiresIn:
          type: integer
          description: Access token expiry in seconds
          example: 900
        user:
          $ref: '#/components/schemas/User'

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          example: Logged out successfully

    Error:
      type: object
      properties:
        statusCode:
          type: integer
          example: 401
        message:
          type: string
          example: Invalid credentials
        error:
          type: string
          example: Unauthorized

    ValidationError:
      type: object
      properties:
        statusCode:
          type: integer
          example: 400
        message:
          type: array
          items:
            type: string
          example:
            - email must be a valid email
            - password must be at least 8 characters
        error:
          type: string
          example: Bad Request
